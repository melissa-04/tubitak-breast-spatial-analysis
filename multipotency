# -*- coding: utf-8 -*-
"""
================================================================================
STEP18: MULTƒ∞POTENCY GENLERƒ∞ KONTROL√ú (FADS1, FADS2, SCD)
================================================================================
CytoTRACE2 makalesinde multipotency ile ili≈ükilendirilen genlerin
spatial transcriptomics verisinde varlƒ±ƒüƒ±nƒ± ve ekspresyonunu kontrol edelim.

Adƒ±m adƒ±m ilerleyeceƒüiz:
1. Genlerin varlƒ±ƒüƒ±nƒ± kontrol et
2. Ekspresyon seviyelerini incele
3. CytoTRACE2 skoru ile korelasyon
4. Front vs Core kar≈üƒ±la≈ütƒ±rmasƒ±
================================================================================
"""

#===============================================================================
# H√úCRE 1: KURULUM VE DRIVE BAƒûLANTISI
#===============================================================================

from google.colab import drive
drive.mount('/content/drive')

!pip install scanpy anndata --quiet

import scanpy as sc
import anndata as ad
import pandas as pd
import numpy as np
import os
from scipy.stats import spearmanr, mannwhitneyu
import matplotlib.pyplot as plt
import seaborn as sns

import warnings
warnings.filterwarnings('ignore')

print("‚úÖ Kurulum tamamlandƒ±!")

#===============================================================================
# H√úCRE 2: DOSYA YOLLARINI TANIMLA
#===============================================================================

BASE_DIR = "/content/drive/MyDrive/T√úBƒ∞TAK"
OUTPUTS_DIR = f"{BASE_DIR}/outputs"

# CytoTRACE2 sonu√ßlarƒ± (STEP16'dan)
CYTOTRACE2_RESULTS_DIR = f"{OUTPUTS_DIR}/STEP16_CANDIDATE_CYTOTRACE2/RESULTS"

# Spatial counts (gen ekspresyonlarƒ± i√ßin)
SPATIAL_COUNTS_DIR = f"{OUTPUTS_DIR}/STEP10_STEREOSCOPE_RUN/INPUTS"

# √áƒ±ktƒ± dizini
OUTPUT_DIR = f"{OUTPUTS_DIR}/STEP18_MULTIPOTENCY"
os.makedirs(OUTPUT_DIR, exist_ok=True)

# 6 hasta
SAMPLES = ["1142243F", "1160920F", "CID4290", "CID4465", "CID4535", "CID44971"]

# Multipotency genleri (CytoTRACE2 makalesinden)
# Not: Fare'de Scd2, insanda SCD (veya SCD1)
MULTIPOTENCY_GENES = ["FADS1", "FADS2", "SCD"]

print("‚úÖ Yollar tanƒ±mlandƒ±!")
print(f"   Aranan genler: {MULTIPOTENCY_GENES}")

#===============================================================================
# H√úCRE 3: GENLERƒ∞N VERƒ∞DE VARLIƒûINI KONTROL ET
#===============================================================================

print("\n" + "="*60)
print("ADIM 1: GENLERƒ∞N VERƒ∞DE VARLIƒûI")
print("="*60)

# ƒ∞lk √∂rneƒüi y√ºkle ve genleri kontrol et
sample = SAMPLES[0]
h5ad_path = f"{SPATIAL_COUNTS_DIR}/spatial_{sample}_counts_intersect.h5ad"

print(f"\nüìÇ Test dosyasƒ±: {sample}")
adata = sc.read_h5ad(h5ad_path)

print(f"   Toplam gen sayƒ±sƒ±: {adata.n_vars}")
print(f"   Toplam spot sayƒ±sƒ±: {adata.n_obs}")

# Genleri kontrol et
print(f"\nüîç Multipotency genleri kontrol√º:")
gene_status = {}
for gene in MULTIPOTENCY_GENES:
    if gene in adata.var_names:
        gene_status[gene] = "‚úÖ BULUNDU"
    else:
        gene_status[gene] = "‚ùå BULUNAMADI"
    print(f"   {gene}: {gene_status[gene]}")

# Alternatif gen isimleri kontrol et
print(f"\nüîç Alternatif isimler kontrol√º:")
alternatives = ["SCD1", "SCD2", "FADS3", "ELOVL", "ELOVL6"]
for gene in alternatives:
    status = "‚úÖ" if gene in adata.var_names else "‚ùå"
    print(f"   {gene}: {status}")

#===============================================================================
# H√úCRE 4: BULUNAN GENLERƒ∞N EKSPRESYON SEVƒ∞YELERƒ∞
#===============================================================================

print("\n" + "="*60)
print("ADIM 2: EKSPRESYON SEVƒ∞YELERƒ∞")
print("="*60)

# Bulunan genleri filtrele
found_genes = [g for g in MULTIPOTENCY_GENES if g in adata.var_names]

if len(found_genes) == 0:
    print("‚ùå Hi√ßbir multipotency geni bulunamadƒ±!")
    print("   Analiz devam edemez.")
else:
    print(f"\n‚úÖ Bulunan genler: {found_genes}")

    # Ham counts'tan ekspresyon istatistikleri
    for gene in found_genes:
        gene_idx = adata.var_names.get_loc(gene)
        counts = adata.X[:, gene_idx].toarray().flatten() if hasattr(adata.X, 'toarray') else adata.X[:, gene_idx].flatten()

        n_expressed = np.sum(counts > 0)
        pct_expressed = (n_expressed / len(counts)) * 100
        mean_expr = np.mean(counts)
        max_expr = np.max(counts)

        print(f"\n   üìä {gene}:")
        print(f"      Eksprese eden spot: {n_expressed}/{len(counts)} ({pct_expressed:.1f}%)")
        print(f"      Ortalama count: {mean_expr:.2f}")
        print(f"      Maksimum count: {max_expr:.0f}")

        if pct_expressed < 5:
            print(f"      ‚ö†Ô∏è UYARI: √áok d√º≈ü√ºk ekspresyon (<5%), analiz g√ºvenilir olmayabilir")
        elif pct_expressed < 20:
            print(f"      ‚ö° Dƒ∞KKAT: D√º≈ü√ºk ekspresyon, dikkatli yorumla")
        else:
            print(f"      ‚úÖ Yeterli ekspresyon seviyesi")

#===============================================================================
# H√úCRE 5: T√úM √ñRNEKLERDE EKSPRESYON KONTROL√ú
#===============================================================================

print("\n" + "="*60)
print("ADIM 3: T√úM √ñRNEKLERDE EKSPRESYON")
print("="*60)

expression_summary = []

for sample in SAMPLES:
    h5ad_path = f"{SPATIAL_COUNTS_DIR}/spatial_{sample}_counts_intersect.h5ad"
    adata = sc.read_h5ad(h5ad_path)

    row = {'sample': sample, 'n_spots': adata.n_obs}

    for gene in found_genes:
        if gene in adata.var_names:
            gene_idx = adata.var_names.get_loc(gene)
            counts = adata.X[:, gene_idx].toarray().flatten() if hasattr(adata.X, 'toarray') else adata.X[:, gene_idx].flatten()

            n_expressed = np.sum(counts > 0)
            pct_expressed = (n_expressed / len(counts)) * 100
            mean_expr = np.mean(counts)

            row[f'{gene}_pct'] = pct_expressed
            row[f'{gene}_mean'] = mean_expr
        else:
            row[f'{gene}_pct'] = 0
            row[f'{gene}_mean'] = 0

    expression_summary.append(row)

expr_df = pd.DataFrame(expression_summary)
print("\nüìã T√ºm √∂rneklerde ekspresyon oranlarƒ± (%):")
print(expr_df.to_string(index=False))

# Ortalama ekspresyon
print("\nüìä Ortalama ekspresyon oranlarƒ±:")
for gene in found_genes:
    avg_pct = expr_df[f'{gene}_pct'].mean()
    print(f"   {gene}: {avg_pct:.1f}%")

#===============================================================================
# H√úCRE 6: CYTOTRACE2 SKORLARI ƒ∞LE Bƒ∞RLE≈ûTƒ∞RME
#===============================================================================

print("\n" + "="*60)
print("ADIM 4: CYTOTRACE2 ƒ∞LE Bƒ∞RLE≈ûTƒ∞RME")
print("="*60)

all_data = []

for sample in SAMPLES:
    print(f"\nüìÇ {sample} i≈üleniyor...")

    # CytoTRACE2 skorlarƒ±nƒ± y√ºkle
    score_file = f"{CYTOTRACE2_RESULTS_DIR}/{sample}/candidate_front_core_scored_{sample}.csv"

    if not os.path.exists(score_file):
        print(f"   ‚ö†Ô∏è Skor dosyasƒ± bulunamadƒ±, atlanƒ±yor")
        continue

    scores_df = pd.read_csv(score_file)

    # Spot ID s√ºtununu d√ºzelt
    if 'spot_id' not in scores_df.columns:
        if 'barcode' in scores_df.columns:
            scores_df = scores_df.rename(columns={'barcode': 'spot_id'})
        elif 'Unnamed: 0' in scores_df.columns:
            scores_df = scores_df.rename(columns={'Unnamed: 0': 'spot_id'})

    # Spatial counts y√ºkle
    h5ad_path = f"{SPATIAL_COUNTS_DIR}/spatial_{sample}_counts_intersect.h5ad"
    adata = sc.read_h5ad(h5ad_path)

    # Normalize et (log2 CPM)
    sc.pp.normalize_total(adata, target_sum=1e6)
    sc.pp.log1p(adata, base=2)

    # Gen ekspresyonlarƒ±nƒ± DataFrame'e √ßevir
    expr_data = {}
    for gene in found_genes:
        if gene in adata.var_names:
            gene_idx = adata.var_names.get_loc(gene)
            expr = adata.X[:, gene_idx].toarray().flatten() if hasattr(adata.X, 'toarray') else adata.X[:, gene_idx].flatten()
            expr_data[gene] = expr

    expr_df = pd.DataFrame(expr_data, index=adata.obs_names)
    expr_df = expr_df.reset_index().rename(columns={'index': 'spot_id'})

    # Birle≈ütir
    scores_filtered = scores_df[scores_df['region'].isin(['front', 'core'])].copy()
    merged = scores_filtered.merge(expr_df, on='spot_id', how='inner')
    merged['sample'] = sample

    all_data.append(merged)
    print(f"   ‚úÖ {len(merged)} spot birle≈ütirildi")

# T√ºm verileri birle≈ütir
pooled = pd.concat(all_data, ignore_index=True)
print(f"\n‚úÖ Toplam: {len(pooled)} spot")
print(f"   Front: {sum(pooled['region']=='front')}")
print(f"   Core: {sum(pooled['region']=='core')}")

#===============================================================================
# H√úCRE 7: CYTOTRACE2 ƒ∞LE KORELASYON ANALƒ∞Zƒ∞
#===============================================================================

print("\n" + "="*60)
print("ADIM 5: CYTOTRACE2 ƒ∞LE KORELASYON")
print("="*60)

# CytoTRACE2 skor s√ºtununu bul
cytotrace_col = None
for col in ['cytotrace2_potency_score', 'potency_score', 'CytoTRACE2_Score', 'score']:
    if col in pooled.columns:
        cytotrace_col = col
        break

if cytotrace_col is None:
    print("‚ùå CytoTRACE2 skor s√ºtunu bulunamadƒ±!")
else:
    print(f"   CytoTRACE2 s√ºtunu: {cytotrace_col}")

    print("\nüìä Spearman Korelasyonlarƒ± (CytoTRACE2 vs Multipotency Genleri):")
    print("-"*50)

    corr_results = []
    for gene in found_genes:
        if gene in pooled.columns:
            valid = pooled[[cytotrace_col, gene]].dropna()
            r, p = spearmanr(valid[cytotrace_col], valid[gene])

            corr_results.append({
                'gene': gene,
                'spearman_r': r,
                'p_value': p,
                'n': len(valid)
            })

            sig = "‚úÖ" if p < 0.05 else "‚ùå"
            direction = "‚Üë" if r > 0 else "‚Üì"
            print(f"   {gene}: r = {r:+.3f} {direction}  p = {p:.2e}  {sig}")

    corr_df = pd.DataFrame(corr_results)

#===============================================================================
# H√úCRE 8: FRONT vs CORE KAR≈ûILA≈ûTIRMASI
#===============================================================================

print("\n" + "="*60)
print("ADIM 6: FRONT vs CORE KAR≈ûILA≈ûTIRMASI")
print("="*60)

comparison_results = []

for gene in found_genes:
    if gene in pooled.columns:
        front_vals = pooled[pooled['region'] == 'front'][gene].dropna()
        core_vals = pooled[pooled['region'] == 'core'][gene].dropna()

        stat, p = mannwhitneyu(front_vals, core_vals, alternative='two-sided')

        result = {
            'gene': gene,
            'front_median': front_vals.median(),
            'core_median': core_vals.median(),
            'delta': front_vals.median() - core_vals.median(),
            'p_value': p,
            'n_front': len(front_vals),
            'n_core': len(core_vals)
        }
        comparison_results.append(result)

        sig = "‚úÖ" if p < 0.05 else "‚ùå"
        direction = "Front > Core" if result['delta'] > 0 else "Core > Front"
        print(f"\n   üìä {gene}:")
        print(f"      Front median: {result['front_median']:.3f}")
        print(f"      Core median:  {result['core_median']:.3f}")
        print(f"      Œî = {result['delta']:+.3f} ({direction})")
        print(f"      p = {p:.2e} {sig}")

comp_df = pd.DataFrame(comparison_results)

#===============================================================================
# H√úCRE 9: G√ñRSELLE≈ûTƒ∞RME
#===============================================================================

print("\n" + "="*60)
print("ADIM 7: G√ñRSELLE≈ûTƒ∞RME")
print("="*60)

n_genes = len(found_genes)

if n_genes > 0 and cytotrace_col:
    fig, axes = plt.subplots(2, n_genes, figsize=(5*n_genes, 10))

    if n_genes == 1:
        axes = axes.reshape(2, 1)

    for i, gene in enumerate(found_genes):
        # √úst satƒ±r: CytoTRACE2 vs Gen scatter
        ax1 = axes[0, i]
        colors = pooled['region'].map({'front': 'red', 'core': 'blue'})
        ax1.scatter(pooled[cytotrace_col], pooled[gene], c=colors, alpha=0.3, s=10)

        r, p = spearmanr(pooled[cytotrace_col].dropna(), pooled[gene].dropna())
        ax1.set_xlabel('CytoTRACE2 Potency')
        ax1.set_ylabel(f'{gene} Expression (log2 CPM)')
        ax1.set_title(f'{gene} vs CytoTRACE2\nr={r:.3f}, p={p:.2e}')

        # Alt satƒ±r: Front vs Core boxplot
        ax2 = axes[1, i]
        plot_data = pooled[['region', gene]].dropna()
        sns.boxplot(data=plot_data, x='region', y=gene, ax=ax2, palette={'front': 'red', 'core': 'blue'})
        ax2.set_xlabel('Region')
        ax2.set_ylabel(f'{gene} Expression')

        p_val = comp_df[comp_df['gene']==gene]['p_value'].values[0]
        ax2.set_title(f'{gene}: Front vs Core\np={p_val:.2e}')

    plt.tight_layout()
    plt.savefig(f"{OUTPUT_DIR}/multipotency_genes_analysis.png", dpi=300, bbox_inches='tight')
    plt.show()

    print(f"\n‚úÖ Fig√ºr kaydedildi: {OUTPUT_DIR}/multipotency_genes_analysis.png")

#===============================================================================
# H√úCRE 10: √ñZET VE SONU√á
#===============================================================================

print("\n" + "="*60)
print("√ñZET SONU√áLAR")
print("="*60)

print("\nüìã Multipotency Genleri Durumu:")
print("-"*50)

for gene in MULTIPOTENCY_GENES:
    if gene in found_genes:
        avg_pct = np.mean([row[f'{gene}_pct'] for row in expression_summary if f'{gene}_pct' in row])

        if gene in corr_df['gene'].values:
            r = corr_df[corr_df['gene']==gene]['spearman_r'].values[0]
            p_corr = corr_df[corr_df['gene']==gene]['p_value'].values[0]
        else:
            r, p_corr = 0, 1

        if gene in comp_df['gene'].values:
            delta = comp_df[comp_df['gene']==gene]['delta'].values[0]
            p_comp = comp_df[comp_df['gene']==gene]['p_value'].values[0]
        else:
            delta, p_comp = 0, 1

        print(f"\n   {gene}:")
        print(f"      Ekspresyon: {avg_pct:.1f}% spotlarda")
        print(f"      CytoTRACE2 korelasyon: r={r:+.3f} (p={p_corr:.2e})")
        print(f"      Front vs Core: Œî={delta:+.3f} (p={p_comp:.2e})")
    else:
        print(f"\n   {gene}: ‚ùå Veride bulunamadƒ±")

# Sonu√ßlarƒ± kaydet
if len(found_genes) > 0:
    corr_df.to_csv(f"{OUTPUT_DIR}/multipotency_cytotrace2_correlation.csv", index=False)
    comp_df.to_csv(f"{OUTPUT_DIR}/multipotency_front_vs_core.csv", index=False)
    print(f"\n‚úÖ Sonu√ßlar kaydedildi: {OUTPUT_DIR}/")

print("\n" + "="*60)
print("ANALƒ∞Z TAMAMLANDI!")
print("="*60)
