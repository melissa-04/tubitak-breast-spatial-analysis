# -*- coding: utf-8 -*-
"""
================================================================================
STEP17: ÃœÃ‡ KATMANLI DOÄRULAMA (KÄ°MLÄ°K - AKTÄ°VÄ°TE - DAVRANIÅ)
================================================================================
TÃœBÄ°TAK 2209-A Projesi
Meme Kanseri Dokusunda Kanser KÃ¶k HÃ¼cre Potansiyelinin Uzamsal HaritalanmasÄ±

Bu notebook, CytoTRACE2 bulgularÄ±nÄ± Ã¼Ã§ katmanlÄ± doÄŸrulama sistemi ile test eder:
1. KÄ°MLÄ°K (Identity): CSC marker genleri (CD44, ALDH1A1, SOX2, NANOG)
2. AKTÄ°VÄ°TE (Activity): Proliferasyon marker'larÄ± (MKI67, PCNA, TOP2A)
3. DAVRANIÅ (Behavior): EMT/invazyon genleri (VIM, CDH1, SNAI1, ZEB1)

AmaÃ§: CytoTRACE2 skorlarÄ±nÄ±n biyolojik olarak anlamlÄ± olduÄŸunu kanÄ±tlamak
================================================================================
"""

#===============================================================================
# HÃœCRE 1: KURULUM VE GOOGLE DRIVE BAÄLANTISI
#===============================================================================
# Bu hÃ¼creyi Ã§alÄ±ÅŸtÄ±rÄ±n - Drive'a baÄŸlanacak ve gerekli kÃ¼tÃ¼phaneler kurulacak

# Google Drive baÄŸlantÄ±sÄ±
from google.colab import drive
drive.mount('/content/drive')

# Gerekli kÃ¼tÃ¼phaneleri kur
!pip install scanpy anndata scipy matplotlib seaborn pandas numpy --quiet

import warnings
warnings.filterwarnings('ignore')

import scanpy as sc
import anndata as ad
import pandas as pd
import numpy as np
import os
from scipy import stats
from scipy.stats import spearmanr, mannwhitneyu
import matplotlib.pyplot as plt
import seaborn as sns

# TÃ¼rkÃ§e karakter desteÄŸi
plt.rcParams['font.family'] = 'DejaVu Sans'

print("âœ… KÃ¼tÃ¼phaneler yÃ¼klendi!")
print(f"   Scanpy: {sc.__version__}")
print(f"   AnnData: {ad.__version__}")

#===============================================================================
# HÃœCRE 2: DOSYA YOLLARINI TANIMLA
#===============================================================================
# Drive'daki dosya yapÄ±sÄ±na gÃ¶re yollarÄ± ayarla

# Ana dizinler
BASE_DIR = "/content/drive/MyDrive/TÃœBÄ°TAK"
OUTPUTS_DIR = f"{BASE_DIR}/outputs"
EXTRACTED_DIR = f"{BASE_DIR}/extracted"

# GiriÅŸ dosyalarÄ± (STEP16'dan gelen candidate CytoTRACE2 sonuÃ§larÄ±)
CYTOTRACE2_RESULTS_DIR = f"{OUTPUTS_DIR}/STEP16_CANDIDATE_CYTOTRACE2/RESULTS"

# Spatial count matrisleri (gen ekspresyonlarÄ± iÃ§in)
SPATIAL_COUNTS_DIR = f"{OUTPUTS_DIR}/STEP10_STEREOSCOPE_RUN/INPUTS"

# Ã‡Ä±ktÄ± dizini
OUTPUT_DIR = f"{OUTPUTS_DIR}/STEP17_VALIDATION"
os.makedirs(OUTPUT_DIR, exist_ok=True)
os.makedirs(f"{OUTPUT_DIR}/FIGURES", exist_ok=True)
os.makedirs(f"{OUTPUT_DIR}/REPORTS", exist_ok=True)

# 6 hasta Ã¶rneÄŸi
SAMPLES = ["1142243F", "1160920F", "CID4290", "CID4465", "CID4535", "CID44971"]

# Alt tip bilgisi (Wu et al. 2021'den)
SAMPLE_SUBTYPES = {
    "1142243F": "TNBC",
    "1160920F": "TNBC",
    "CID4290": "ER+",
    "CID4465": "TNBC",
    "CID4535": "ER+",
    "CID44971": "TNBC"
}

print("âœ… Dosya yollarÄ± tanÄ±mlandÄ±!")
print(f"   Ã‡Ä±ktÄ±lar ÅŸuraya kaydedilecek: {OUTPUT_DIR}")

#===============================================================================
# HÃœCRE 3: DOÄRULAMA GEN LÄ°STELERÄ°NÄ° TANIMLA
#===============================================================================
# ÃœÃ§ katmanlÄ± doÄŸrulama iÃ§in kullanÄ±lacak genler

# KATMAN 1: KÄ°MLÄ°K (Identity) - CSC Marker Genleri
# Bu genler kanser kÃ¶k hÃ¼cre kimliÄŸini tanÄ±mlar
CSC_MARKERS = {
    "CD44": "CSC yÃ¼zey marker'Ä±, meme kanserinde iyi karakterize edilmiÅŸ",
    "ALDH1A1": "Aldehit dehidrojenaz, CSC metabolik marker'Ä±",
    "SOX2": "Pluripotency transkripsiyon faktÃ¶rÃ¼",
    "NANOG": "Pluripotency transkripsiyon faktÃ¶rÃ¼",
    "POU5F1": "OCT4, pluripotency marker'Ä±",
    "KLF4": "Yamauchi faktÃ¶rÃ¼, stemness ile iliÅŸkili",
    "MYC": "c-MYC, proliferasyon ve stemness"
}

# KATMAN 2: AKTÄ°VÄ°TE (Activity) - Proliferasyon Marker'larÄ±
# CSC'ler genellikle dÃ¼ÅŸÃ¼k proliferasyon gÃ¶sterir (quiescent)
PROLIFERATION_MARKERS = {
    "MKI67": "Ki-67, aktif proliferasyon marker'Ä±",
    "PCNA": "DNA replikasyon marker'Ä±",
    "TOP2A": "Topoizomeraz II, hÃ¼cre bÃ¶lÃ¼nmesi",
    "MCM2": "DNA replikasyon lisanslama",
    "CCNB1": "Siklin B1, G2/M fazÄ±",
    "CDK1": "Siklin baÄŸÄ±mlÄ± kinaz 1"
}

# KATMAN 3: DAVRANIÅ (Behavior) - EMT/Ä°nvazyon Genleri
# Ä°nvaziv cephedeki hÃ¼creler EMT Ã¶zellikleri gÃ¶sterebilir
EMT_MARKERS = {
    "VIM": "Vimentin, mezenkimal marker",
    "CDH1": "E-cadherin, epitelyal marker (dÃ¼ÅŸÃ¼k = EMT)",
    "CDH2": "N-cadherin, mezenkimal marker",
    "SNAI1": "Snail, EMT transkripsiyon faktÃ¶rÃ¼",
    "SNAI2": "Slug, EMT transkripsiyon faktÃ¶rÃ¼",
    "ZEB1": "EMT transkripsiyon faktÃ¶rÃ¼",
    "ZEB2": "EMT transkripsiyon faktÃ¶rÃ¼",
    "TWIST1": "EMT transkripsiyon faktÃ¶rÃ¼",
    "FN1": "Fibronektin, ECM/invazyon"
}

print("âœ… Gen listeleri tanÄ±mlandÄ±!")
print(f"   Kimlik katmanÄ±: {len(CSC_MARKERS)} gen")
print(f"   Aktivite katmanÄ±: {len(PROLIFERATION_MARKERS)} gen")
print(f"   DavranÄ±ÅŸ katmanÄ±: {len(EMT_MARKERS)} gen")

#===============================================================================
# HÃœCRE 4: VERÄ°LERÄ° YÃœKLE VE BÄ°RLEÅTÄ°R
#===============================================================================
# Her Ã¶rnek iÃ§in CytoTRACE2 skorlarÄ± ve gen ekspresyonlarÄ±nÄ± birleÅŸtir

def load_and_merge_data(sample_id):
    """
    Bir Ã¶rnek iÃ§in CytoTRACE2 skorlarÄ±nÄ± ve gen ekspresyonlarÄ±nÄ± birleÅŸtirir.
    
    Returns:
        DataFrame: spot_id, cytotrace2_score, region (front/core), gen ekspresyonlarÄ±
    """
    
    # 1. CytoTRACE2 skorlarÄ±nÄ± yÃ¼kle (front/core etiketli)
    score_file = f"{CYTOTRACE2_RESULTS_DIR}/{sample_id}/candidate_front_core_scored_{sample_id}.csv"
    
    if not os.path.exists(score_file):
        print(f"   âš ï¸ {sample_id}: Skor dosyasÄ± bulunamadÄ±")
        return None
    
    scores_df = pd.read_csv(score_file)
    
    # SÃ¼tun isimlerini kontrol et ve dÃ¼zelt
    # OlasÄ± sÃ¼tun isimleri: 'spot_id', 'barcode', 'Unnamed: 0', index
    if 'spot_id' not in scores_df.columns:
        if 'barcode' in scores_df.columns:
            scores_df = scores_df.rename(columns={'barcode': 'spot_id'})
        elif 'Unnamed: 0' in scores_df.columns:
            scores_df = scores_df.rename(columns={'Unnamed: 0': 'spot_id'})
        else:
            scores_df['spot_id'] = scores_df.index.astype(str)
    
    # 2. Spatial counts h5ad'i yÃ¼kle (gen ekspresyonlarÄ± iÃ§in)
    h5ad_file = f"{SPATIAL_COUNTS_DIR}/spatial_{sample_id}_counts_intersect.h5ad"
    
    if not os.path.exists(h5ad_file):
        print(f"   âš ï¸ {sample_id}: H5AD dosyasÄ± bulunamadÄ±")
        return None
    
    adata = sc.read_h5ad(h5ad_file)
    
    # 3. Gen ekspresyonlarÄ±nÄ± DataFrame'e Ã§evir
    # Log2(CPM+1) normalizasyon yap
    sc.pp.normalize_total(adata, target_sum=1e6)
    sc.pp.log1p(adata, base=2)
    
    # TÃ¼m genleri DataFrame'e al
    expr_df = pd.DataFrame(
        adata.X.toarray() if hasattr(adata.X, 'toarray') else adata.X,
        index=adata.obs_names,
        columns=adata.var_names
    )
    expr_df = expr_df.reset_index().rename(columns={'index': 'spot_id'})
    
    # 4. Skorlar ve ekspresyonlarÄ± birleÅŸtir
    # Sadece front veya core olan spotlarÄ± al
    scores_filtered = scores_df[scores_df['region'].isin(['front', 'core'])].copy()
    
    merged = scores_filtered.merge(expr_df, on='spot_id', how='inner')
    
    print(f"   âœ“ {sample_id}: {len(merged)} spot yÃ¼klendi (front: {sum(merged['region']=='front')}, core: {sum(merged['region']=='core')})")
    
    return merged

# TÃ¼m Ã¶rnekleri yÃ¼kle
print("\nğŸ“‚ Veriler yÃ¼kleniyor...")
all_data = {}
for sample in SAMPLES:
    data = load_and_merge_data(sample)
    if data is not None:
        data['sample_id'] = sample
        data['subtype'] = SAMPLE_SUBTYPES[sample]
        all_data[sample] = data

# TÃ¼m verileri birleÅŸtir (pooled analiz iÃ§in)
if all_data:
    pooled_data = pd.concat(all_data.values(), ignore_index=True)
    print(f"\nâœ… Toplam {len(pooled_data)} spot yÃ¼klendi!")
    print(f"   Front: {sum(pooled_data['region']=='front')}")
    print(f"   Core: {sum(pooled_data['region']=='core')}")
else:
    print("âŒ Veri yÃ¼klenemedi!")

#===============================================================================
# HÃœCRE 5: GEN SKORU HESAPLAMA FONKSÄ°YONLARI
#===============================================================================
# Her katman iÃ§in skor hesaplama

def calculate_gene_score(df, gene_list, score_name):
    """
    Verilen gen listesi iÃ§in ortalama ekspresyon skoru hesaplar.
    
    Args:
        df: DataFrame (spotlar x genler)
        gene_list: dict veya list (gen isimleri)
        score_name: str (Ã§Ä±ktÄ± sÃ¼tun adÄ±)
    
    Returns:
        DataFrame: orijinal df + yeni skor sÃ¼tunu
    """
    genes = list(gene_list.keys()) if isinstance(gene_list, dict) else gene_list
    
    # Veri setinde bulunan genleri filtrele
    available_genes = [g for g in genes if g in df.columns]
    missing_genes = [g for g in genes if g not in df.columns]
    
    if missing_genes:
        print(f"   âš ï¸ {score_name}: Bulunamayan genler: {missing_genes}")
    
    if not available_genes:
        print(f"   âŒ {score_name}: HiÃ§ gen bulunamadÄ±!")
        df[score_name] = np.nan
        return df
    
    # Ortalama ekspresyon skoru
    df[score_name] = df[available_genes].mean(axis=1)
    
    print(f"   âœ“ {score_name}: {len(available_genes)}/{len(genes)} gen kullanÄ±ldÄ±")
    
    return df

def calculate_emt_score(df):
    """
    EMT skoru hesaplar: Mezenkimal genler - Epitelyal genler
    YÃ¼ksek skor = daha mezenkimal (EMT aktif)
    """
    mesenchymal = ['VIM', 'CDH2', 'SNAI1', 'SNAI2', 'ZEB1', 'ZEB2', 'TWIST1', 'FN1']
    epithelial = ['CDH1']  # E-cadherin
    
    mes_available = [g for g in mesenchymal if g in df.columns]
    epi_available = [g for g in epithelial if g in df.columns]
    
    if mes_available:
        df['mesenchymal_score'] = df[mes_available].mean(axis=1)
    else:
        df['mesenchymal_score'] = 0
    
    if epi_available:
        df['epithelial_score'] = df[epi_available].mean(axis=1)
    else:
        df['epithelial_score'] = 0
    
    # EMT skoru = mezenkimal - epitelyal
    df['emt_score'] = df['mesenchymal_score'] - df['epithelial_score']
    
    print(f"   âœ“ EMT skoru: {len(mes_available)} mezenkimal, {len(epi_available)} epitelyal gen")
    
    return df

# SkorlarÄ± hesapla
print("\nğŸ“Š Gen skorlarÄ± hesaplanÄ±yor...")

# Pooled data iÃ§in
pooled_data = calculate_gene_score(pooled_data, CSC_MARKERS, 'csc_score')
pooled_data = calculate_gene_score(pooled_data, PROLIFERATION_MARKERS, 'proliferation_score')
pooled_data = calculate_emt_score(pooled_data)

print("\nâœ… TÃ¼m skorlar hesaplandÄ±!")

#===============================================================================
# HÃœCRE 6: KATMAN 1 - KÄ°MLÄ°K DOÄRULAMASI (CSC Markers)
#===============================================================================
# CytoTRACE2 skorlarÄ± ile CSC marker ekspresyonlarÄ± arasÄ±ndaki korelasyon

print("\n" + "="*70)
print("KATMAN 1: KÄ°MLÄ°K DOÄRULAMASI (CSC Marker'larÄ±)")
print("="*70)
print("Hipotez: YÃ¼ksek CytoTRACE2 skoru â†’ YÃ¼ksek CSC marker ekspresyonu")
print("-"*70)

# CytoTRACE2 skor sÃ¼tun adÄ±nÄ± bul
cytotrace_col = None
for col in ['cytotrace2_potency_score', 'potency_score', 'CytoTRACE2_Score', 'score']:
    if col in pooled_data.columns:
        cytotrace_col = col
        break

if cytotrace_col is None:
    print("âŒ CytoTRACE2 skor sÃ¼tunu bulunamadÄ±!")
    print(f"   Mevcut sÃ¼tunlar: {pooled_data.columns.tolist()[:20]}...")
else:
    print(f"   CytoTRACE2 skor sÃ¼tunu: {cytotrace_col}")

# Korelasyon analizi
def correlation_analysis(df, score_col, gene_dict, layer_name):
    """
    CytoTRACE2 skorlarÄ± ile gen ekspresyonlarÄ± arasÄ±nda korelasyon analizi.
    """
    results = []
    
    for gene, description in gene_dict.items():
        if gene in df.columns and score_col in df.columns:
            # NaN'larÄ± Ã§Ä±kar
            valid = df[[score_col, gene]].dropna()
            
            if len(valid) > 10:
                r, p = spearmanr(valid[score_col], valid[gene])
                results.append({
                    'gene': gene,
                    'description': description,
                    'spearman_r': r,
                    'p_value': p,
                    'n_spots': len(valid)
                })
    
    results_df = pd.DataFrame(results)
    
    if len(results_df) > 0:
        # FDR dÃ¼zeltmesi (Bonferroni)
        results_df['p_adjusted'] = results_df['p_value'] * len(results_df)
        results_df['p_adjusted'] = results_df['p_adjusted'].clip(upper=1.0)
        results_df['significant'] = results_df['p_adjusted'] < 0.05
        results_df = results_df.sort_values('spearman_r', ascending=False)
    
    return results_df

if cytotrace_col:
    csc_correlation = correlation_analysis(pooled_data, cytotrace_col, CSC_MARKERS, "CSC")
    
    print("\nğŸ“‹ CSC Marker KorelasyonlarÄ± (CytoTRACE2 ile):")
    print("-"*70)
    for _, row in csc_correlation.iterrows():
        sig = "âœ“" if row['significant'] else " "
        print(f"   {sig} {row['gene']:10s} r={row['spearman_r']:+.3f}  p_adj={row['p_adjusted']:.2e}  ({row['description'][:40]})")
    
    # Ã–zet
    print(f"\n   ğŸ“Š Ã–zet: {csc_correlation['significant'].sum()}/{len(csc_correlation)} gen anlamlÄ± korelasyon gÃ¶sterdi")
    
    # Kaydet
    csc_correlation.to_csv(f"{OUTPUT_DIR}/REPORTS/layer1_csc_correlation.csv", index=False)

#===============================================================================
# HÃœCRE 7: KATMAN 2 - AKTÄ°VÄ°TE DOÄRULAMASI (Proliferasyon)
#===============================================================================
# CSC'ler genellikle dÃ¼ÅŸÃ¼k proliferasyon gÃ¶sterir (quiescent phenotype)

print("\n" + "="*70)
print("KATMAN 2: AKTÄ°VÄ°TE DOÄRULAMASI (Proliferasyon)")
print("="*70)
print("Hipotez: YÃ¼ksek CytoTRACE2 skoru â†’ DÃ¼ÅŸÃ¼k proliferasyon (quiescent CSC)")
print("-"*70)

if cytotrace_col:
    prolif_correlation = correlation_analysis(pooled_data, cytotrace_col, PROLIFERATION_MARKERS, "Proliferation")
    
    print("\nğŸ“‹ Proliferasyon Marker KorelasyonlarÄ± (CytoTRACE2 ile):")
    print("-"*70)
    for _, row in prolif_correlation.iterrows():
        sig = "âœ“" if row['significant'] else " "
        direction = "â¬†ï¸" if row['spearman_r'] > 0 else "â¬‡ï¸"
        print(f"   {sig} {row['gene']:10s} r={row['spearman_r']:+.3f} {direction}  p_adj={row['p_adjusted']:.2e}")
    
    # Yorum
    mean_r = prolif_correlation['spearman_r'].mean()
    print(f"\n   ğŸ“Š Ortalama korelasyon: r={mean_r:+.3f}")
    if mean_r < 0:
        print("   âœ“ Beklenen: YÃ¼ksek potency â†’ dÃ¼ÅŸÃ¼k proliferasyon (quiescent CSC)")
    else:
        print("   âš ï¸ Not: Pozitif korelasyon - aktif prolifere eden progenitÃ¶rler olabilir")
    
    # Kaydet
    prolif_correlation.to_csv(f"{OUTPUT_DIR}/REPORTS/layer2_proliferation_correlation.csv", index=False)

#===============================================================================
# HÃœCRE 8: KATMAN 3 - DAVRANIÅ DOÄRULAMASI (EMT/Ä°nvazyon)
#===============================================================================
# Ä°nvaziv cephedeki hÃ¼creler EMT Ã¶zellikleri gÃ¶sterebilir

print("\n" + "="*70)
print("KATMAN 3: DAVRANIÅ DOÄRULAMASI (EMT/Ä°nvazyon)")
print("="*70)
print("Hipotez: Ä°nvaziv cephe (front) â†’ YÃ¼ksek EMT skoru")
print("-"*70)

if cytotrace_col:
    emt_correlation = correlation_analysis(pooled_data, cytotrace_col, EMT_MARKERS, "EMT")
    
    print("\nğŸ“‹ EMT Marker KorelasyonlarÄ± (CytoTRACE2 ile):")
    print("-"*70)
    for _, row in emt_correlation.iterrows():
        sig = "âœ“" if row['significant'] else " "
        print(f"   {sig} {row['gene']:10s} r={row['spearman_r']:+.3f}  p_adj={row['p_adjusted']:.2e}")
    
    # EMT skoru: Front vs Core karÅŸÄ±laÅŸtÄ±rmasÄ±
    print("\nğŸ“Š EMT Skoru: Front vs Core KarÅŸÄ±laÅŸtÄ±rmasÄ±")
    print("-"*70)
    
    front_emt = pooled_data[pooled_data['region'] == 'front']['emt_score'].dropna()
    core_emt = pooled_data[pooled_data['region'] == 'core']['emt_score'].dropna()
    
    stat, p_value = mannwhitneyu(front_emt, core_emt, alternative='two-sided')
    
    print(f"   Front EMT skoru: {front_emt.median():.3f} (median), n={len(front_emt)}")
    print(f"   Core EMT skoru:  {core_emt.median():.3f} (median), n={len(core_emt)}")
    print(f"   Î” (Front - Core): {front_emt.median() - core_emt.median():+.3f}")
    print(f"   Mann-Whitney U p-value: {p_value:.2e}")
    
    if p_value < 0.05:
        if front_emt.median() > core_emt.median():
            print("   âœ“ AnlamlÄ±: Front bÃ¶lgesi daha yÃ¼ksek EMT skoru gÃ¶steriyor")
        else:
            print("   âœ“ AnlamlÄ±: Core bÃ¶lgesi daha yÃ¼ksek EMT skoru gÃ¶steriyor")
    else:
        print("   â—‹ AnlamlÄ± fark yok")
    
    # Kaydet
    emt_correlation.to_csv(f"{OUTPUT_DIR}/REPORTS/layer3_emt_correlation.csv", index=False)

#===============================================================================
# HÃœCRE 9: FRONT VS CORE - TÃœM KATMANLAR KARÅILAÅTIRMASI
#===============================================================================
# Her katman iÃ§in front vs core farkÄ±nÄ± test et

print("\n" + "="*70)
print("TÃœM KATMANLAR: FRONT vs CORE KARÅILAÅTIRMASI")
print("="*70)

comparison_results = []

scores_to_compare = [
    (cytotrace_col, "CytoTRACE2 Potency"),
    ('csc_score', "CSC Marker Skoru"),
    ('proliferation_score', "Proliferasyon Skoru"),
    ('emt_score', "EMT Skoru")
]

for score_col, score_name in scores_to_compare:
    if score_col and score_col in pooled_data.columns:
        front_vals = pooled_data[pooled_data['region'] == 'front'][score_col].dropna()
        core_vals = pooled_data[pooled_data['region'] == 'core'][score_col].dropna()
        
        if len(front_vals) > 0 and len(core_vals) > 0:
            stat, p = mannwhitneyu(front_vals, core_vals, alternative='two-sided')
            
            result = {
                'score_type': score_name,
                'front_median': front_vals.median(),
                'front_mean': front_vals.mean(),
                'core_median': core_vals.median(),
                'core_mean': core_vals.mean(),
                'delta_median': front_vals.median() - core_vals.median(),
                'delta_mean': front_vals.mean() - core_vals.mean(),
                'mwu_statistic': stat,
                'p_value': p,
                'n_front': len(front_vals),
                'n_core': len(core_vals)
            }
            comparison_results.append(result)

comparison_df = pd.DataFrame(comparison_results)

# FDR dÃ¼zeltmesi
if len(comparison_df) > 0:
    comparison_df['p_adjusted'] = comparison_df['p_value'] * len(comparison_df)
    comparison_df['p_adjusted'] = comparison_df['p_adjusted'].clip(upper=1.0)
    comparison_df['significant'] = comparison_df['p_adjusted'] < 0.05

print("\nğŸ“‹ Front vs Core KarÅŸÄ±laÅŸtÄ±rma SonuÃ§larÄ±:")
print("-"*70)
print(f"{'Skor Tipi':<25} {'Front Med':>10} {'Core Med':>10} {'Î”':>10} {'p-value':>12} {'AnlamlÄ±':>8}")
print("-"*70)

for _, row in comparison_df.iterrows():
    sig = "âœ“" if row['significant'] else " "
    print(f"{row['score_type']:<25} {row['front_median']:>10.3f} {row['core_median']:>10.3f} {row['delta_median']:>+10.3f} {row['p_value']:>12.2e} {sig:>8}")

# Kaydet
comparison_df.to_csv(f"{OUTPUT_DIR}/REPORTS/front_vs_core_all_layers.csv", index=False)
print(f"\nâœ… SonuÃ§lar kaydedildi: {OUTPUT_DIR}/REPORTS/front_vs_core_all_layers.csv")

#===============================================================================
# HÃœCRE 10: ALT GRUP ANALÄ°ZÄ° (ER+ vs TNBC)
#===============================================================================
# MolekÃ¼ler alt tiplere gÃ¶re karÅŸÄ±laÅŸtÄ±rma

print("\n" + "="*70)
print("ALT GRUP ANALÄ°ZÄ°: ER+ vs TNBC")
print("="*70)

subtype_results = []

for subtype in ['ER+', 'TNBC']:
    subtype_data = pooled_data[pooled_data['subtype'] == subtype]
    
    if len(subtype_data) == 0:
        continue
    
    print(f"\nğŸ“Š {subtype} (n={len(subtype_data)} spot)")
    print("-"*50)
    
    front_data = subtype_data[subtype_data['region'] == 'front']
    core_data = subtype_data[subtype_data['region'] == 'core']
    
    if cytotrace_col and len(front_data) > 0 and len(core_data) > 0:
        front_scores = front_data[cytotrace_col].dropna()
        core_scores = core_data[cytotrace_col].dropna()
        
        if len(front_scores) > 0 and len(core_scores) > 0:
            stat, p = mannwhitneyu(front_scores, core_scores, alternative='two-sided')
            
            result = {
                'subtype': subtype,
                'n_front': len(front_scores),
                'n_core': len(core_scores),
                'front_median': front_scores.median(),
                'core_median': core_scores.median(),
                'delta_median': front_scores.median() - core_scores.median(),
                'p_value': p
            }
            subtype_results.append(result)
            
            print(f"   Front: n={len(front_scores)}, median={front_scores.median():.3f}")
            print(f"   Core:  n={len(core_scores)}, median={core_scores.median():.3f}")
            print(f"   Î” (Front-Core): {front_scores.median() - core_scores.median():+.3f}")
            print(f"   p-value: {p:.4f}")

if subtype_results:
    subtype_df = pd.DataFrame(subtype_results)
    subtype_df.to_csv(f"{OUTPUT_DIR}/REPORTS/subtype_analysis_ER_vs_TNBC.csv", index=False)
    print(f"\nâœ… Alt grup analizi kaydedildi: {OUTPUT_DIR}/REPORTS/subtype_analysis_ER_vs_TNBC.csv")

#===============================================================================
# HÃœCRE 11: GÃ–RSELLEÅTÄ°RME - KORELASYON HEATMAP
#===============================================================================
# TÃ¼m korelasyonlarÄ± tek bir heatmap'te gÃ¶ster

print("\n" + "="*70)
print("GÃ–RSELLEÅTÄ°RME")
print("="*70)

fig, axes = plt.subplots(2, 2, figsize=(14, 12))

# 1. CytoTRACE2 vs CSC Score scatter
ax1 = axes[0, 0]
if cytotrace_col and 'csc_score' in pooled_data.columns:
    colors = pooled_data['region'].map({'front': 'red', 'core': 'blue'})
    ax1.scatter(pooled_data[cytotrace_col], pooled_data['csc_score'], 
                c=colors, alpha=0.3, s=10)
    
    # Korelasyon hesapla
    valid = pooled_data[[cytotrace_col, 'csc_score']].dropna()
    r, p = spearmanr(valid[cytotrace_col], valid['csc_score'])
    
    ax1.set_xlabel('CytoTRACE2 Potency Score')
    ax1.set_ylabel('CSC Marker Score')
    ax1.set_title(f'Katman 1: Kimlik DoÄŸrulamasÄ±\nr={r:.3f}, p={p:.2e}')
    ax1.legend(handles=[plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='red', label='Front'),
                        plt.Line2D([0], [0], marker='o', color='w', markerfacecolor='blue', label='Core')])

# 2. CytoTRACE2 vs Proliferation Score scatter
ax2 = axes[0, 1]
if cytotrace_col and 'proliferation_score' in pooled_data.columns:
    colors = pooled_data['region'].map({'front': 'red', 'core': 'blue'})
    ax2.scatter(pooled_data[cytotrace_col], pooled_data['proliferation_score'], 
                c=colors, alpha=0.3, s=10)
    
    valid = pooled_data[[cytotrace_col, 'proliferation_score']].dropna()
    r, p = spearmanr(valid[cytotrace_col], valid['proliferation_score'])
    
    ax2.set_xlabel('CytoTRACE2 Potency Score')
    ax2.set_ylabel('Proliferation Score')
    ax2.set_title(f'Katman 2: Aktivite DoÄŸrulamasÄ±\nr={r:.3f}, p={p:.2e}')

# 3. CytoTRACE2 vs EMT Score scatter
ax3 = axes[1, 0]
if cytotrace_col and 'emt_score' in pooled_data.columns:
    colors = pooled_data['region'].map({'front': 'red', 'core': 'blue'})
    ax3.scatter(pooled_data[cytotrace_col], pooled_data['emt_score'], 
                c=colors, alpha=0.3, s=10)
    
    valid = pooled_data[[cytotrace_col, 'emt_score']].dropna()
    r, p = spearmanr(valid[cytotrace_col], valid['emt_score'])
    
    ax3.set_xlabel('CytoTRACE2 Potency Score')
    ax3.set_ylabel('EMT Score')
    ax3.set_title(f'Katman 3: DavranÄ±ÅŸ DoÄŸrulamasÄ±\nr={r:.3f}, p={p:.2e}')

# 4. Front vs Core - TÃ¼m skorlar violin plot
ax4 = axes[1, 1]
if cytotrace_col:
    plot_data = pooled_data[['region', cytotrace_col, 'csc_score', 'proliferation_score', 'emt_score']].melt(
        id_vars=['region'], 
        var_name='Score Type', 
        value_name='Score'
    )
    plot_data = plot_data.dropna()
    
    # Score type isimlerini kÄ±salt
    plot_data['Score Type'] = plot_data['Score Type'].replace({
        cytotrace_col: 'CytoTRACE2',
        'csc_score': 'CSC',
        'proliferation_score': 'Prolif.',
        'emt_score': 'EMT'
    })
    
    sns.boxplot(data=plot_data, x='Score Type', y='Score', hue='region', ax=ax4)
    ax4.set_title('Front vs Core: TÃ¼m Katmanlar')
    ax4.legend(title='Region')

plt.tight_layout()
plt.savefig(f"{OUTPUT_DIR}/FIGURES/validation_all_layers.png", dpi=300, bbox_inches='tight')
plt.show()

print(f"âœ… FigÃ¼r kaydedildi: {OUTPUT_DIR}/FIGURES/validation_all_layers.png")

#===============================================================================
# HÃœCRE 12: Ã–ZET RAPOR OLUÅTUR
#===============================================================================
# TÃ¼m bulgularÄ± Ã¶zetleyen rapor

print("\n" + "="*70)
print("Ã–ZET RAPOR")
print("="*70)

summary_text = f"""
================================================================================
STEP17: ÃœÃ‡ KATMANLI DOÄRULAMA SONUÃ‡LARI
================================================================================

Analiz Tarihi: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')}
Toplam Spot SayÄ±sÄ±: {len(pooled_data)}
  - Front: {sum(pooled_data['region']=='front')}
  - Core: {sum(pooled_data['region']=='core')}

--------------------------------------------------------------------------------
KATMAN 1: KÄ°MLÄ°K DOÄRULAMASI (CSC Marker'larÄ±)
--------------------------------------------------------------------------------
"""

if 'csc_correlation' in dir() and len(csc_correlation) > 0:
    summary_text += f"KullanÄ±lan Genler: {', '.join(csc_correlation['gene'].tolist())}\n"
    summary_text += f"AnlamlÄ± Korelasyon: {csc_correlation['significant'].sum()}/{len(csc_correlation)} gen\n"
    mean_r = csc_correlation['spearman_r'].mean()
    summary_text += f"Ortalama Spearman r: {mean_r:+.3f}\n"

summary_text += f"""
--------------------------------------------------------------------------------
KATMAN 2: AKTÄ°VÄ°TE DOÄRULAMASI (Proliferasyon)
--------------------------------------------------------------------------------
"""

if 'prolif_correlation' in dir() and len(prolif_correlation) > 0:
    summary_text += f"KullanÄ±lan Genler: {', '.join(prolif_correlation['gene'].tolist())}\n"
    mean_r = prolif_correlation['spearman_r'].mean()
    summary_text += f"Ortalama Spearman r: {mean_r:+.3f}\n"
    if mean_r < 0:
        summary_text += "Yorum: Negatif korelasyon - yÃ¼ksek potency dÃ¼ÅŸÃ¼k proliferasyonla iliÅŸkili (quiescent CSC)\n"

summary_text += f"""
--------------------------------------------------------------------------------
KATMAN 3: DAVRANIÅ DOÄRULAMASI (EMT/Ä°nvazyon)
--------------------------------------------------------------------------------
"""

if 'emt_correlation' in dir():
    summary_text += f"EMT Skoru Front vs Core:\n"
    summary_text += f"  Front median: {front_emt.median():.3f}\n"
    summary_text += f"  Core median: {core_emt.median():.3f}\n"
    summary_text += f"  p-value: {p_value:.2e}\n"

summary_text += f"""
--------------------------------------------------------------------------------
FRONT vs CORE: TÃœM KATMANLAR Ã–ZET
--------------------------------------------------------------------------------
"""

if 'comparison_df' in dir() and len(comparison_df) > 0:
    for _, row in comparison_df.iterrows():
        sig = "ANLAMLI" if row['significant'] else "anlamsÄ±z"
        summary_text += f"{row['score_type']}: Î”={row['delta_median']:+.3f}, p={row['p_value']:.2e} ({sig})\n"

summary_text += """
================================================================================
SONUÃ‡
================================================================================
Bu Ã¼Ã§ katmanlÄ± doÄŸrulama, CytoTRACE2 potency skorlarÄ±nÄ±n:
1. CSC marker ekspresyonlarÄ±yla iliÅŸkili olduÄŸunu
2. Proliferasyon durumu ile tutarlÄ± olduÄŸunu  
3. EMT/invazyon davranÄ±ÅŸÄ±yla baÄŸlantÄ±lÄ± olduÄŸunu
gÃ¶stermektedir (veya gÃ¶stermemektedir - sonuÃ§lara gÃ¶re yorumlanacak).

Bu bulgular, invaziv cephe hipotezinin doÄŸrulanmasÄ±nÄ± destekler.
================================================================================
"""

# Kaydet
with open(f"{OUTPUT_DIR}/REPORTS/validation_summary_report.txt", 'w', encoding='utf-8') as f:
    f.write(summary_text)

print(summary_text)
print(f"\nâœ… Ã–zet rapor kaydedildi: {OUTPUT_DIR}/REPORTS/validation_summary_report.txt")

#===============================================================================
# HÃœCRE 13: TÃœM Ã‡IKTILARI LÄ°STELE
#===============================================================================

print("\n" + "="*70)
print("KAYDEDILEN DOSYALAR")
print("="*70)

import glob

saved_files = glob.glob(f"{OUTPUT_DIR}/**/*", recursive=True)
saved_files = [f for f in saved_files if os.path.isfile(f)]

print(f"\nğŸ“ {OUTPUT_DIR}/")
for f in sorted(saved_files):
    relative_path = f.replace(OUTPUT_DIR + "/", "")
    size = os.path.getsize(f)
    print(f"   {relative_path} ({size/1024:.1f} KB)")

print(f"\nâœ… Toplam {len(saved_files)} dosya kaydedildi!")
print("\nğŸ‰ STEP17 TAMAMLANDI!")
